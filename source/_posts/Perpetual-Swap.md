---
title: Perpetual Swap
date: 2020-04-14 22:05:04
tags:
---

# 永续合约Perpetual Swap

> 个人学习研究永续合约的一些笔记整理

## 资金费用 funding

### 资金费用=仓位价值*资金费率

### 资金费率为正，多头向空头支付；为负，则空头向多头支付

### 资金费率

- 溢价指数 (P) + clamp (利率 (I) - 溢价指数 (P), 0.05%, -0.05%)

### 溢价/折价

- 溢价指数 (P) = ( Max ( 0 , 深度加权买价 - 标记价格) - Max ( 0 , 标记价格 - 深度加权卖价)) / 现货价格 + 标记价格的合理基差
- 合理基差率 = (深度加权中间价 / 指数价格 - 1) / (距离到期的时间 / 365)

- 合理基差   = 指数价格 * 合理基差率 * (距离到期的时间 / 365)
- 合理价格   = 指数价格 + 合理基差


### 借贷利率

- 基础货币借贷利率

	- https://www.bitmex.com/app/index/.XBTBON

- 计价货币借贷利率

	- https://www.bitmex.com/app/index/.USDBON

### 费用周期

-  3 (因为资金每 8 小时产生)

### 资金费用划转后产生已实现收益

### 资金费用划转后，冻结保证金及爆仓价可能会发生变化

## 标记价格fair price mark

### 避免在高杠杆产品上发生不必要的强制平仓

### 指数价格

- 多个主流交易所的价格加权组成

### 计算：指数价格加上随时间递减的资金费用基差

- 公式：指数价格 * (1 + 资金费用基差率)
- 资金费用基差率

	- 资金费率 *  (至下一个缴付资金费用的时间 / 资金费用时间间隔)

- 基差代表期货合约相比于标的现货价格，处于溢价还是折价；它一般是一个年化百分比。 由于期货合约是在未来到期，因此基差始终存在；到期价格的不确定性也包括了正或负的时间价值。

### 用于计算未实现收益

### 用于强制平仓的触发价格

## 正向反向

### 正向（线性）：usd做保证金及收益结算

- 适合做多
- 一张合约价值为固定单位BTC，如0.1BTC，则其usdt价值会随行情产生盈亏波动，从而影响保证金余额

### 反向：标的物btc做保证金及结算

- 适合做空
- 反向合约，1x做空不会爆仓
- 一张合约价值为固定单位额度usd，如1usd，则其btc价值会随行情产生盈亏波动，从而影响保证金余额

## 合约交易trade

### 下单place order

- open开仓

	- open long开多
	- open short开空

- close平仓

	- close long平多
	- close short平空

### 委托类型order type

- 限价委托Limit Orders

	- post-only (只做maker）
	- IOC ( immediate or cancel)
	- FOK (fill or kill)

- 市价委托Market Orders
- 止损委托Stop Orders

	- 市价止损委托Stop Market Order
	- 限价止损委托Stop Limit Order
	- 追踪止损委托Trailing Stop Order

		- 追踪价距，如果价格反向移动达到追踪价距，市价委托将被触发
		- 正的追踪价距表示追踪买委托，而负的价距代表追踪卖委托

	- 触发价

		- 最新交易价格
		- 标记价格
		- 指数价格

	- 状态事件

		- 未触发
		- 已触发
		- 已成交

- 止盈委托Take Profit Orders
- 高级委托Advanced Order

	- 隐藏委托Hiden Orders

		- 一个限价委托，但是在委托列表中不可见。
		- 一直缴付提取流动性佣金，taker

	- 冰山委托Iceberg Orders

		- 一种特殊的隐藏委托，委托的一部分显示在公开的委托列表中。
		- 设置可显示委托量，优先成交隐藏量，直到隐藏委托量成交完，订单即成为普通限价委托
		- 冰山委托一直缴付提取流动性佣金，直至其隐藏数量被完全执行。之后，它变成一个普通的委托，并将获得提供流动性佣金。即隐藏部分收taker费率，显示部分收maker费率

	- 被动委托Post Only Orders

		- 一种限价委托，永远不会提取流动性，也就是不会成为taker

### 撮合match

- 价格优先
- 时间优先

### 盈亏计算PNL

- 已实现盈亏

	- 因为交易手续费的原因，如果是吃单成交，则大多数情况下会立即产生已实现损失，被收取taker费率
	- 永续合约在每一轮资金费用的结算后会产生已实现盈亏
	- 用户的实际平仓成交价格产生已实现盈亏

- 未实现盈亏

	- 由标记价格计算而来

## 手续费率fee

### maker

### taker

### 强平费率

## 市场中断事件(MDE)

### Market Disruption Event

## 强制平仓liquidated

### 平仓价格

- 保证金余额低于维持保证金时的标记价格
- 即仓位亏损=起始保证金-维持保证金时的标记价格
- 保证金余额=维持保证金+taker手续费时的标记价格为强平价格（也可表示为：保证金率=维持保证金率+taker费率时的价格）
- 保证金率=保证金余额/仓位价值
- 全仓：保证金余额=账户余额+已实现盈亏+未实现盈亏
- 仓位价值=（合约张数*合约面值）/标记价格

### 强平过程

- 1.取消该合约所有未成交委托，释放保证金
- 2.如果此时还未能满足维持保证金要求，此仓位被强平引擎于破产价格接管
- 平台接管的爆仓单会计算出一个可以尽快成交、尽可能增加爆仓盈余的价格，委托到市场，可能高于破产价格，也可能低于破产价格
- bitmex出现宕机后，平台接管的爆仓单，平台自主选择委托价位进行处理
- 系统收益及损失

	- 优于破产价格则进入保险基金
	- 无法在破产价格平仓，则花费保险基金在市场中平仓
	- 保险基金如果无法覆盖损失，则启动自动减仓机制

### 穿仓

- 破产价格
- 爆仓单以低于破产价格平仓

### 保险基金

- 保险基金额的增长来自强平委托在市场上于优于破产价的价格成交。
- 低于破产价格的爆仓单的损失优先使用保险基金弥补

### 自动减仓

- 前提条件

	- 强平仓位未能够在市场平仓
	- 标记价格达到破产价格

- 减仓顺序决定因素

	- 杠杆
	- 盈利比例
	- 计算

		- 排序=盈利百分比 * 有效杠杆  (如果盈利)
		- 盈利百分比 / 有效杠杆  (如果亏损)
		- 有效杠杆 = abs(标记价值) / (标记价值 - 破产价值
		-  盈利百分比 = (标记价值 - 平均开仓价值) / abs(平均开仓价值)
		-  标记价值 = 位于标记价格时的仓位价值
		-  破产价值 = 位于破产价格时的仓位价值
		-  平均开仓价值 = 位于平均开仓价格时的仓位价值

- 自动减仓将根据强平仓位的破产价格进行平仓
- 优先等级

	- 指示器

		- 杠杆盈利比

- 触发流程

	- 通知用户
	- 未成交委托被取消

### 用户的交易记录

- 在你的交易历史中，强平仓位在破产价格（相当于你的维持保证金为 0）被平仓。

## 保证金margin

### 起始保证金

### 维持保证金

- 平仓所需要的佣金也会加入到MM

### 风险限额

### 全仓逐仓

- 全仓保证金：保证金是在仓位间是分享的。 在需要时，一个合约的仓位将从账户余额中提取更多的保证金，以避免爆仓。
- 逐仓保证金：分配给某仓位的保证金被限制在一定数额。 如果仓位的保证金跌到维持保证金水平以下，此仓位将被强制平仓。 在此方法下，你仍然可以增加或减少此仓位的保证金。
- 没有逐仓的可以通过子账户实现

### 同时有买卖委托

- 净买值需要保证金
- 全部卖委托需要全额保证金